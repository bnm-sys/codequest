{% extends "base.html" %}

{% block title %}Learning Center - {{ course.title }} | CodeQuest{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/xterm@5.3.0/css/xterm.css" />
<style>
    .holo-glow {
        background: radial-gradient(circle at top, rgba(0,255,204,.18), transparent 55%),
                    radial-gradient(circle at 20% 20%, rgba(0,136,255,.12), transparent 45%),
                    radial-gradient(circle at 80% 0%, rgba(255,51,153,.14), transparent 50%);
        filter: blur(120px);
    }
    #terminal-container.fullscreen {
        height: 70vh !important;
    }
    .lesson-panel {
        transition: opacity .4s ease, transform .4s ease;
    }
    .lesson-panel.animate-panel-in {
        animation: panelFade .45s ease;
    }
    @keyframes panelFade {
        from { opacity: 0; transform: translateY(12px); }
        to { opacity: 1; transform: translateY(0); }
    }
</style>
{% endblock %}

{% block content %}
<div class="relative isolate">
    <div class="holo-glow absolute inset-0 opacity-70"></div>
    <div class="relative z-10 space-y-10">
        <!-- Header -->
        <div class="flex flex-col gap-6 lg:flex-row lg:items-end lg:justify-between">
            <div class="space-y-3">
                <p class="text-xs tracking-[0.3em] uppercase text-zinc-500">Live Mission</p>
                <h1 class="text-4xl font-bold text-terminal drop-shadow">{{ course.title }}</h1>
                <p class="text-zinc-300 max-w-3xl leading-relaxed">{{ course.description }}</p>
            </div>
            <div class="grid grid-cols-3 gap-4 text-center">
                <div class="bg-zinc-900/70 border border-terminal/30 rounded-xl px-5 py-3">
                    <p class="text-xs uppercase text-zinc-500">Progress</p>
                    <p class="text-3xl font-bold text-terminal">{{ enrollment.progress }}%</p>
                </div>
                <div class="bg-zinc-900/70 border border-terminal/30 rounded-xl px-5 py-3">
                    <p class="text-xs uppercase text-zinc-500">XP Earned</p>
                    <p class="text-3xl font-bold text-terminal">{{ enrollment.xp }}</p>
                </div>
                <div class="bg-zinc-900/70 border border-terminal/30 rounded-xl px-5 py-3">
                    <p class="text-xs uppercase text-zinc-500">Streak</p>
                    <p class="text-3xl font-bold text-terminal">{{ enrollment.streak }} üî•</p>
                </div>
            </div>
        </div>

        {% if challenge %}
        <div class="space-y-10">
            <!-- Mission Landscape Card -->
            <section class="relative overflow-hidden rounded-[32px] border border-terminal/30 bg-gradient-to-r from-zinc-950 via-black to-zinc-950 p-10 shadow-[0_25px_80px_rgba(0,0,0,.65)]">
                <div class="flex flex-col gap-6 lg:flex-row lg:items-center lg:justify-between">
                    <div class="space-y-3">
                        <p class="text-xs uppercase tracking-[0.55em] text-terminal/60">Mission Briefing</p>
                        <h2 class="text-4xl font-bold text-terminal drop-shadow leading-tight">{{ challenge.title|default:"Challenge" }}</h2>
                        <p class="text-zinc-400 text-base max-w-3xl">{{ active_module.title }} ¬∑ {{ course.title }}</p>
                    </div>
                    <div class="flex flex-wrap items-center gap-3 text-xs uppercase tracking-[0.3em]">
                        <span class="inline-flex items-center gap-2 rounded-full border border-blue-500/40 bg-blue-500/10 px-4 py-2 text-blue-200">
                            <i class="fas fa-signal"></i> {{ challenge.difficulty|title }}
                        </span>
                        <span class="inline-flex items-center gap-2 rounded-full border border-emerald-400/40 bg-emerald-400/10 px-4 py-2 text-emerald-200">
                            <i class="fas fa-star"></i> {{ challenge.module.points }} XP
                        </span>
                        <span class="inline-flex items-center gap-2 rounded-full border border-terminal/30 bg-terminal/10 px-4 py-2 text-terminal">
                            <i class="fas fa-clock"></i> Auto-Graded
                        </span>
                    </div>
                </div>
                <div id="ticket-punch-card" class="mt-8 grid gap-6 rounded-2xl border border-terminal/25 bg-black/40 px-6 py-5 sm:grid-cols-3">
                    <div>
                        <p class="text-xs uppercase tracking-[0.45em] text-terminal/60">Ticket Punch</p>
                        <p class="text-4xl font-bold text-terminal tracking-tight" id="ticket-count-display">00</p>
                    </div>
                    <div class="text-sm text-zinc-400">
                        Each briefing you complete stamps this holographic ticket. Reach the final punch to unlock the sandbox.
                    </div>
                    <div class="text-right text-xs uppercase tracking-[0.3em] text-zinc-500">
                        Panel <span id="panel-index-display" class="text-terminal text-2xl mx-1">01</span> /
                        <span id="panel-total-display" class="text-terminal/70 text-2xl">03</span>
                    </div>
                </div>
            </section>

            <!-- Lesson Panels occupying full landscape width -->
            <section id="lesson-panels" class="space-y-8">
                {% if challenge.theory_content %}
                <article class="lesson-panel hidden relative overflow-hidden rounded-[32px] border border-blue-400/40 bg-gradient-to-r from-[#10233b] via-[#090f1c] to-[#050609] p-10 shadow-2xl" data-panel="theory">
                    <div class="flex flex-col gap-6 lg:flex-row lg:justify-between lg:items-start">
                        <div class="space-y-4 max-w-4xl">
                            <div class="flex items-center gap-4">
                                <div class="h-12 w-12 rounded-full bg-blue-500/80 text-white flex items-center justify-center font-bold text-lg shadow-lg">01</div>
                                <div>
                                    <p class="text-xs uppercase tracking-[0.45em] text-blue-200/70">Briefing</p>
                                    <h3 class="text-3xl font-semibold text-blue-100 drop-shadow">Understand the Theory</h3>
                                </div>
                            </div>
                            <div class="prose prose-invert max-w-none leading-relaxed text-zinc-100 space-y-3">
                                {{ challenge.theory_content }}
                            </div>
                            {% if mission_visualization %}
                            <div class="rounded-2xl border border-terminal/20 bg-black/40 p-6 space-y-4">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <p class="text-xs uppercase tracking-[0.45em] text-terminal/60">Visualization</p>
                                        <h4 class="text-xl font-semibold text-terminal">{{ mission_visualization.title }}</h4>
                                        <p class="text-xs text-zinc-400">{{ mission_visualization.subtitle }}</p>
                                    </div>
                                    <div class="text-terminal/70 text-3xl">
                                        <i class="fas {{ mission_visualization.icon|default:'fa-folder-tree' }}"></i>
                                    </div>
                                </div>
                                <div class="grid gap-3 sm:grid-cols-2">
                                    {% for item in mission_visualization.items %}
                                    <div class="relative rounded-2xl border {% if item.highlight %}border-terminal/60 bg-terminal/5{% else %}border-terminal/15 bg-black/30{% endif %} px-4 py-3">
                                        <div class="flex items-center justify-between mb-1">
                                            <span class="font-semibold text-terminal">{{ item.name }}</span>
                                            <i class="fas fa-caret-right text-terminal/50 text-sm"></i>
                                        </div>
                                        <p class="text-xs text-zinc-400 leading-relaxed">{{ item.desc }}</p>
                                        {% if item.highlight %}
                                        <span class="absolute -top-2 -right-2 rounded-full bg-terminal text-terminal-dark text-[10px] px-2 py-0.5 uppercase tracking-wide">Focus</span>
                                        {% endif %}
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                            {% endif %}
                        </div>
                        <button class="panel-advance group flex items-center gap-3 rounded-full border border-blue-400/50 bg-blue-500/10 px-5 py-3 text-blue-200 text-sm font-semibold tracking-wide hover:bg-blue-500/20 transition"
                                data-panel-index="0">
                            Advance Briefing
                            <span class="h-8 w-8 rounded-full border border-blue-300/40 flex items-center justify-center group-hover:bg-blue-500/20 transition">
                                <i class="fas fa-arrow-right"></i>
                            </span>
                        </button>
                    </div>
                </article>
                {% endif %}

                {% if challenge.visualization_script %}
                <article class="lesson-panel hidden relative overflow-hidden rounded-[32px] border border-purple-400/40 bg-gradient-to-r from-[#2a0f37] via-[#13061f] to-[#07030b] p-10 shadow-2xl" data-panel="visualization">
                    <div class="flex flex-col gap-6 lg:flex-row lg:justify-between lg:items-start">
                        <div class="space-y-4 max-w-4xl">
                            <div class="flex items-center gap-4">
                                <div class="h-12 w-12 rounded-full bg-purple-500/80 text-white flex items-center justify-center font-bold text-lg shadow-lg">02</div>
                                <div>
                                    <p class="text-xs uppercase tracking-[0.45em] text-purple-200/70">Visualization</p>
                                    <h3 class="text-3xl font-semibold text-purple-100">See the Command Work</h3>
                                </div>
                            </div>
                            <p class="text-sm text-zinc-300">Paste this script into the sandbox once it unlocks to watch the filesystem react.</p>
                            <div class="bg-black/80 border border-terminal/40 rounded-2xl p-5 font-mono text-terminal text-base shadow-inner">
                                <code class="block">{{ challenge.visualization_script }}</code>
                            </div>
                            <p class="text-xs text-zinc-500 italic">Tip: Pair this output with the visualization map above to reinforce recall.</p>
                        </div>
                        <button class="panel-advance group flex items-center gap-3 rounded-full border border-purple-400/50 bg-purple-500/10 px-5 py-3 text-purple-100 text-sm font-semibold tracking-wide hover:bg-purple-500/20 transition"
                                data-panel-index="1">
                            Ready For Practice
                            <span class="h-8 w-8 rounded-full border border-purple-300/40 flex items-center justify-center group-hover:bg-purple-500/20 transition">
                                <i class="fas fa-arrow-right"></i>
                            </span>
                        </button>
                    </div>
                </article>
                {% endif %}

                <article class="lesson-panel hidden relative overflow-hidden rounded-[32px] border border-emerald-400/40 bg-gradient-to-r from-[#0f2b26] via-[#081412] to-[#030605] p-10 shadow-2xl" data-panel="practice">
                    <div class="flex flex-col gap-6 lg:flex-row lg:justify-between lg:items-start">
                        <div class="space-y-4 max-w-4xl">
                            <div class="flex items-center gap-4">
                                <div class="h-12 w-12 rounded-full bg-emerald-500/80 text-white flex items-center justify-center font-bold text-lg shadow-lg">03</div>
                                <div>
                                    <p class="text-xs uppercase tracking-[0.45em] text-emerald-200/70">Practice</p>
                                    <h3 class="text-3xl font-semibold text-emerald-100">Execute & Earn</h3>
                                </div>
                            </div>
                            <div class="text-zinc-100 leading-relaxed whitespace-pre-wrap text-base">
                                {{ challenge.prompt }}
                            </div>
                            {% if challenge.command_to_practice %}
                            <div class="bg-black/60 border border-terminal/30 rounded-2xl p-5 space-y-2">
                                <p class="text-xs text-zinc-400 uppercase tracking-[0.35em] font-semibold">Command to Practice</p>
                                <code class="block bg-black/80 border border-terminal/40 rounded-xl px-4 py-3 text-terminal text-lg font-mono">
                                    {{ challenge.command_to_practice }}
                                </code>
                            </div>
                            {% endif %}
                            <div class="rounded-xl border border-terminal/30 bg-terminal/10 px-4 py-3 text-sm text-terminal">
                                Auto-grading live. Execute the command exactly once ready‚Äîthe sandbox rewards instantly.
                            </div>
                        </div>
                        <button class="panel-advance group flex items-center gap-3 rounded-full border border-emerald-400/50 bg-emerald-500/10 px-5 py-3 text-emerald-200 text-sm font-semibold tracking-wide hover:bg-emerald-500/20 transition"
                                data-panel-index="2">
                            Unlock Sandbox
                            <span class="h-8 w-8 rounded-full border border-emerald-300/40 flex items-center justify-center group-hover:bg-emerald-500/20 transition">
                                <i class="fas fa-unlock"></i>
                            </span>
                        </button>
                    </div>
                </article>
            </section>

            <!-- Terminal Floating Button -->
            <button id="terminal-fab" class="fixed bottom-6 right-6 z-20 flex items-center gap-3 rounded-full border border-terminal/30 bg-black/70 px-5 py-3 text-sm text-terminal shadow-2xl backdrop-blur"
                    type="button">
                <span class="flex h-9 w-9 items-center justify-center rounded-full border border-terminal/40 bg-terminal/10 text-xl" id="terminal-fab-icon">
                    <i class="fas fa-terminal"></i>
                </span>
                <div class="text-left">
                    <p class="text-xs uppercase tracking-[0.4em] text-terminal/60">Sandbox</p>
                    <p class="font-semibold" id="terminal-fab-text">Locked ¬∑ Finish briefing</p>
                </div>
            </button>

            <!-- Terminal Suite -->
            <section id="terminal-section" class="hidden rounded-[32px] border-2 border-terminal/40 bg-black/85 shadow-[0_25px_80px_rgba(0,0,0,.65)]">
                <div class="flex flex-wrap items-center justify-between gap-3 border-b border-terminal/20 px-6 py-4">
                    <div>
                        <p class="text-xs uppercase tracking-[0.35em] text-zinc-500">Immersive Sandbox</p>
                        <p class="text-xl font-semibold text-terminal">Adaptive Terminal Environment</p>
                    </div>
                    <div class="flex flex-wrap gap-3 text-sm">
                        <button id="expand-terminal-btn" class="rounded-lg border border-terminal/30 px-4 py-2 text-terminal hover:border-terminal"><i class="fas fa-expand mr-2"></i>Expand</button>
                        <button id="reset-terminal-btn" class="rounded-lg border border-red-500/40 px-4 py-2 text-red-300 hover:border-red-400"><i class="fas fa-rotate mr-2"></i>Reset</button>
                        <button id="start-sandbox-btn" class="rounded-lg bg-terminal px-5 py-2 font-semibold text-terminal-dark hover:bg-terminal/80"><i class="fas fa-power-off mr-2"></i>Launch Terminal</button>
                    </div>
                </div>
                <div class="bg-black">
                    <div id="terminal-container" class="font-mono text-sm h-[28rem] md:h-[32rem] lg:h-[36rem] px-4 py-3"></div>
                </div>
                <div class="flex items-center justify-between border-t border-terminal/10 px-6 py-3 text-xs text-zinc-500">
                    <div class="flex items-center gap-2"><span class="text-terminal">‚óè</span> <span id="terminal-status">Awaiting connection</span></div>
                    <p>Auto-evaluation after each command</p>
                </div>
                <div id="result-feedback" class="mx-6 mb-6 mt-4 hidden rounded-xl border bg-zinc-900/70 px-5 py-4 text-sm text-zinc-200"></div>
            </section>
        </div>
        {% else %}
        <div class="rounded-2xl border border-terminal/30 bg-zinc-900/60 p-10 text-center">
            <h2 class="text-3xl font-semibold text-terminal mb-4">All Missions Complete! üéâ</h2>
            <p class="text-zinc-300 mb-6">You've cleared every challenge in this module. Visit the dashboard to choose another path.</p>
            <a href="{% url 'courses:dashboard' %}" class="rounded-lg bg-terminal px-6 py-3 font-semibold text-terminal-dark hover:bg-terminal/80">Back to Dashboard</a>
        </div>
        {% endif %}

        <!-- Module Progress -->
        <section class="rounded-2xl border border-terminal/20 bg-zinc-900/60 p-6 space-y-4">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-xs uppercase tracking-[0.3em] text-zinc-500">Flight Plan</p>
                    <h3 class="text-xl font-semibold text-terminal">Module Progress</h3>
                </div>
                <span class="text-sm text-zinc-400">{{ course.modules.count }} modules</span>
            </div>
            <div class="space-y-3">
                {% for module in course.modules.all %}
                <div class="rounded-xl border border-terminal/10 bg-black/40 px-4 py-3 flex items-center justify-between">
                    <div>
                        <p class="font-medium text-terminal">{{ module.title }}</p>
                        <p class="text-xs text-zinc-500">{{ module.challenges.count }} challenges</p>
                    </div>
                    <div class="text-terminal text-lg"><i class="fas fa-signal"></i></div>
                </div>
                {% empty %}
                <p class="text-sm text-zinc-500">Modules coming soon.</p>
                {% endfor %}
            </div>
        </section>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/xterm@5.3.0/lib/xterm.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xterm-addon-fit@0.8.0/lib/xterm-addon-fit.js"></script>
<script>
const challengeId = {{ challenge.id|default:"null" }};
const sandboxApiUrl = '/sandbox/api/sessions/';
const promptSymbol = '$ ';
let terminal = null;
let fitAddon = null;
let sessionId = null;
let isSandboxActive = false;
let isProcessingCommand = false;
let currentLine = '';
let commandHistory = [];
let historyIndex = -1;

function initLessonPanels() {
    const panels = Array.from(document.querySelectorAll('.lesson-panel'));
    const panelAdvanceButtons = document.querySelectorAll('.panel-advance');
    const panelIndexDisplay = document.getElementById('panel-index-display');
    const panelTotalDisplay = document.getElementById('panel-total-display');
    const ticketDisplay = document.getElementById('ticket-count-display');
    const ticketCard = document.getElementById('ticket-punch-card');
    const terminalSection = document.getElementById('terminal-section');
    const terminalFab = document.getElementById('terminal-fab');
    const terminalFabText = document.getElementById('terminal-fab-text');
    const terminalFabIcon = document.getElementById('terminal-fab-icon');

    if (!panels.length) {
        terminalSection?.classList.remove('hidden');
        terminalFab?.classList.add('hidden');
        return;
    }

    let activePanel = 0;
    let ticketPunches = 0;
    let terminalUnlocked = false;

    if (panelTotalDisplay) {
        panelTotalDisplay.textContent = String(panels.length).padStart(2, '0');
    }

    const animateTicket = () => {
        ticketPunches = Math.min(ticketPunches + 1, panels.length);
        if (ticketDisplay) {
            ticketDisplay.textContent = String(ticketPunches).padStart(2, '0');
        }
        if (ticketCard) {
            ticketCard.classList.add('ring-2', 'ring-terminal/60');
            setTimeout(() => ticketCard.classList.remove('ring-2', 'ring-terminal/60'), 400);
        }
    };

    const renderPanels = () => {
        panels.forEach((panel, idx) => {
            const isActive = idx === activePanel;
            panel.classList.toggle('hidden', !isActive);
            panel.classList.toggle('animate-panel-in', isActive);
        });
        if (panelIndexDisplay) {
            panelIndexDisplay.textContent = String(activePanel + 1).padStart(2, '0');
        }
    };

    const unlockTerminal = () => {
        if (terminalUnlocked) return;
        terminalUnlocked = true;
        terminalSection?.classList.remove('hidden');
        terminalSection?.classList.add('animate-panel-in');
        if (terminalFab) {
            terminalFab.classList.add('bg-terminal', 'text-terminal-dark');
            terminalFab.classList.remove('bg-black/70', 'text-terminal');
            terminalFabText.textContent = 'Open Sandbox';
            terminalFabIcon.innerHTML = '<i class="fas fa-unlock"></i>';
        }
        document.getElementById('start-sandbox-btn')?.focus();
    };

    const advanceFromPanel = (panelIndex) => {
        if (terminalUnlocked) {
            document.getElementById('terminal-section')?.scrollIntoView({ behavior: 'smooth', block: 'start' });
            return;
        }
        if (activePanel < panels.length - 1) {
            activePanel = panelIndex + 1;
            animateTicket();
            renderPanels();
        } else {
            animateTicket();
            unlockTerminal();
            document.getElementById('terminal-section')?.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
    };

    panelAdvanceButtons.forEach(btn => {
        btn.addEventListener('click', () => {
            const panelIndex = parseInt(btn.dataset.panelIndex || '0', 10);
            activePanel = panelIndex;
            advanceFromPanel(panelIndex);
        });
    });

    terminalFab?.addEventListener('click', () => {
        if (terminalUnlocked) {
            document.getElementById('terminal-section')?.scrollIntoView({ behavior: 'smooth', block: 'start' });
        } else {
            terminalFab.classList.add('animate-pulse');
            setTimeout(() => terminalFab.classList.remove('animate-pulse'), 600);
        }
    });

    renderPanels();
}

function initTerminal() {
    terminal = new Terminal({
        cursorBlink: true,
        fontSize: 15,
        lineHeight: 1.2,
        fontFamily: 'Share Tech Mono, monospace',
        theme: {
            background: '#020303',
            foreground: '#00ffcc',
            cursor: '#00ffcc',
            selection: 'rgba(0,255,204,.25)'
        }
    });
    fitAddon = new FitAddon.FitAddon();
    terminal.loadAddon(fitAddon);
    const container = document.getElementById('terminal-container');
    container.innerHTML = '';
    terminal.open(container);
    fitAddon.fit();

    terminal.onData(data => handleTerminalInput(data));
}

function handleTerminalInput(data) {
    if (data === '\u001b[A') { navigateHistory(-1); return; }
    if (data === '\u001b[B') { navigateHistory(1); return; }

    if (!isSandboxActive || !sessionId) {
        terminal.write('\r\nTerminal offline. Launch it first.');
        showPrompt();
        return;
    }

    const code = data.charCodeAt(0);

    if (code === 13 || code === 10) {
        if (currentLine.trim() && !isProcessingCommand) {
            const command = currentLine.trim();
            pushToHistory(command);
            currentLine = '';
            isProcessingCommand = true;
            terminal.write('\r\n');
            sendCommand(command);
        } else {
            showPrompt();
        }
        return;
    }

    if (code === 3) {
        currentLine = '';
        terminal.write('^C');
        showPrompt();
        return;
    }

    if (code === 127 || code === 8) {
        if (currentLine.length > 0) {
            currentLine = currentLine.slice(0, -1);
            terminal.write('\b \b');
        }
        return;
    }

    if (code >= 32 && code <= 126) {
        currentLine += data;
        terminal.write(data);
    }
}

function pushToHistory(command) {
    if (!command) return;
    if (commandHistory[commandHistory.length - 1] !== command) {
        commandHistory.push(command);
    }
    historyIndex = commandHistory.length;
}

function navigateHistory(direction) {
    if (!commandHistory.length) return;
    historyIndex = Math.min(commandHistory.length, Math.max(0, historyIndex + direction));
    currentLine = commandHistory[historyIndex] || '';
    refreshCurrentLine();
}

function refreshCurrentLine() {
    terminal.write(`\x1b[2K\r${promptSymbol}${currentLine}`);
}

function showPrompt(newLine = true) {
    if (newLine) terminal.write('\r\n');
    terminal.write(promptSymbol);
}

async function startSandbox() {
    const btn = document.getElementById('start-sandbox-btn');
    const status = document.getElementById('terminal-status');
    btn.disabled = true;
    btn.textContent = 'Launching...';
    status.textContent = 'Connecting...';
    status.classList.remove('text-green-400');
    status.classList.add('text-orange-300');
    currentLine = '';
    commandHistory = [];
    historyIndex = -1;

    try {
        const response = await fetch(sandboxApiUrl, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({ challenge_id: challengeId })
        });
        if (!response.ok) throw new Error('Failed to create sandbox session');
        const data = await response.json();
        sessionId = data.id;
        isSandboxActive = true;
        terminal.write('\x1b[2J\x1b[H');
        terminal.write('\x1b[32mConnected to immersive sandbox.\x1b[0m\r\n');
        terminal.write('\x1b[33mCommands auto-grade on execution.\x1b[0m');
        showPrompt();
        btn.classList.add('hidden');
        status.textContent = 'Connected';
        status.classList.remove('text-orange-300');
        status.classList.add('text-green-400');
    } catch (error) {
        terminal.write(`\r\n\x1b[31m${error.message}\x1b[0m`);
        status.textContent = 'Connection failed';
        status.classList.remove('text-green-400');
        status.classList.add('text-red-400');
        btn.disabled = false;
        btn.textContent = 'Launch Terminal';
    }
}

async function stopSandboxSession() {
    if (!sessionId) {
        terminal.write('\r\nNo active session to reset.');
        showPrompt();
        return;
    }
    try {
        await fetch(`${sandboxApiUrl}${sessionId}/stop/`, {
            method: 'POST',
            headers: { 'X-CSRFToken': getCookie('csrftoken') }
        });
    } catch (error) {
        console.warn(error);
    }
    sessionId = null;
    isSandboxActive = false;
    currentLine = '';
    terminal.write('\r\nSession reset. Launch again when ready.');
    document.getElementById('start-sandbox-btn').classList.remove('hidden');
    document.getElementById('start-sandbox-btn').disabled = false;
    document.getElementById('start-sandbox-btn').textContent = 'Launch Terminal';
    document.getElementById('terminal-status').textContent = 'Awaiting connection';
    document.getElementById('terminal-status').classList.remove('text-green-400');
    document.getElementById('terminal-status').classList.remove('text-orange-300');
    document.getElementById('terminal-status').classList.add('text-zinc-400');
    showPrompt();
}

async function sendCommand(command) {
    if (!sessionId) {
        isProcessingCommand = false;
        showPrompt();
        return;
    }
    try {
        const response = await fetch(`${sandboxApiUrl}${sessionId}/execute/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({ command })
        });
        const data = await response.json();
        const errorOutput = (data.error && data.exit_code !== 0) ? `\r\n${data.error}` : '';
        const consoleOutput = `${data.output || ''}${errorOutput}`;
        if (consoleOutput) {
            terminal.write(consoleOutput);
        }
        await evaluateCommand(command, consoleOutput);
    } catch (error) {
        terminal.write(`\r\n\x1b[31m${error.message}\x1b[0m`);
    } finally {
        isProcessingCommand = false;
        showPrompt();
    }
}

async function evaluateCommand(command, output) {
    if (!challengeId || !sessionId) return;
    const trimmed = (output || '').trim();
    if (!trimmed) return;
    const panel = document.getElementById('result-feedback');
    try {
        const response = await fetch(`${sandboxApiUrl}${sessionId}/evaluate/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({ output: trimmed, command })
        });
        if (!response.ok) return;
        const data = await response.json();
        panel.classList.remove('hidden');
        if (data.is_correct) {
            panel.className = 'mx-6 mb-6 mt-4 rounded-xl border border-emerald-400/60 bg-emerald-500/10 px-5 py-4 text-sm text-emerald-100';
            panel.innerHTML = `
                <div class="flex flex-col gap-1">
                    <div class="flex items-center gap-2 text-emerald-300 font-semibold"><i class="fas fa-check-circle"></i> Mission accomplished</div>
                    <p>${data.feedback}</p>
                    <p class="text-xs text-emerald-200/70">+${data.xp_awarded || 0} XP ¬∑ Progress ${data.progress || 0}%</p>
                </div>`;
            setTimeout(() => window.location.reload(), data.course_completed ? 2200 : 1400);
        } else {
            panel.className = 'mx-6 mb-6 mt-4 rounded-xl border border-amber-400/60 bg-amber-500/10 px-5 py-4 text-sm text-amber-100';
            panel.innerHTML = `
                <div class="flex flex-col gap-1">
                    <div class="flex items-center gap-2 text-amber-300 font-semibold"><i class="fas fa-lightbulb"></i> Keep iterating</div>
                    <p>${data.feedback}</p>
                    <p class="text-xs text-amber-200/70">Expected signal: ${data.expected_output}</p>
                </div>`;
        }
    } catch (error) {
        console.error(error);
    }
}

function toggleTerminalSize() {
    const container = document.getElementById('terminal-container');
    const btn = document.getElementById('expand-terminal-btn');
    const expanded = container.classList.toggle('fullscreen');
    btn.innerHTML = expanded ? '<i class="fas fa-compress mr-2"></i>Collapse' : '<i class="fas fa-expand mr-2"></i>Expand';
    setTimeout(() => fitAddon?.fit(), 120);
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

document.addEventListener('DOMContentLoaded', () => {
    initLessonPanels();
    initTerminal();
    document.getElementById('start-sandbox-btn')?.addEventListener('click', startSandbox);
    document.getElementById('reset-terminal-btn')?.addEventListener('click', stopSandboxSession);
    document.getElementById('expand-terminal-btn')?.addEventListener('click', toggleTerminalSize);
    window.addEventListener('resize', () => fitAddon?.fit());
});
</script>
{% endblock %}
