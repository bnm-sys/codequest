name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

# Please read CONTRIBUTING.md for guidelines on:
# - Code style and formatting
# - Testing requirements
# - PR submission process
# - Code review standards

jobs:
  lint:
    name: Code Quality
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'
    
    - name: Cache dependencies
      uses: actions/cache@v4
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install flake8 black isort
    
    - name: Run Black
      run: black --check .
    
    - name: Run isort
      run: isort --check-only .
    
    - name: Run Flake8
      run: flake8 .

  test:
    name: Tests
    runs-on: ubuntu-latest
    
    services:
      postgres:
        image: postgres:13
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: codequest
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    
    env:
      SECRET_KEY: test-secret-key-for-ci
      DEBUG: True
      ALLOWED_HOSTS: localhost,127.0.0.1
      DB_NAME: codequest
      DB_USER: postgres
      DB_PASSWORD: postgres
      DB_HOST: localhost
      DB_PORT: 5432
      EMAIL_HOST: localhost
      EMAIL_PORT: 1025
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'
    
    - name: Cache dependencies
      uses: actions/cache@v4
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest pytest-django
    
    - name: Run migrations
      run: python manage.py migrate
    
    - name: Run tests
      run: pytest -v --tb=short
    
    - name: Check contribution guidelines
      if: github.event_name == 'pull_request'
      run: |
        echo "âœ… CI/CD checks passed!"
        echo ""
        echo "ðŸ“‹ Next Steps:"
        echo "1. Ensure your PR description follows the template in CONTRIBUTING.md"
        echo "2. Address any review comments promptly"
        echo "3. Keep your branch updated with the base branch"
        echo ""
        echo "Thank you for contributing to CodeQuest! ðŸŽ‰"
    
    - name: Upload coverage
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: test-results
        path: .pytest_cache/
